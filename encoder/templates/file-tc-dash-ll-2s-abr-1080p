#!/bin/bash

#Generated by command builder r0.3h
#Script expects two variables to be set 'stream' (Stream ID) and 'event' (Event name)

timestamp="$(date +%s)"

ffmpeg \
\
-re -fflags +genpts -stream_loop -1 -i testclip.mp4 \
\
-flags +global_header -r 30000/1001 \
\
-filter_complex "settb=AVTB,\
setpts='trunc(PTS/1K)*1K+st(1,trunc(RTCTIME/1K))-1K*trunc(ld(1)/1K)',\
drawbox=x=0:y=0:width=400:height=100:color=black@0.5:t=fill,\
drawtext=text='%{localtime\:%M}\:%{localtime\:%S}.%{eif\:1M*t-1K*trunc(t*1K)\:d\:3}':x=15:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
drawbox=x=1460:y=0:width=460:height=100:color=black@0.5:t=fill,\
split=7[s0][s1][s2][s3][s4][s5][s6];\
[s0]drawtext=text='1080p-6.0M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=1920x1080[s0];\
[s1]drawtext=text='1080p-4.5M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=1920x1080[s1];\
[s2]drawtext=text='720p-3.0M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=1280x720[s2];\
[s3]drawtext=text='540p-2.0M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=960x540[s3];\
[s4]drawtext=text='432p-1.1M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=768x432[s4];\
[s5]drawtext=text='360p-0.7M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=640x360[s5];\
[s6]drawtext=text='270p-0.4M':x=1480:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
scale=480x270[s6]" \
\
-pix_fmt yuv420p \
-c:v libx264 \
\
-b:v:0 6000K -maxrate:v:0 6000K -bufsize:v:0 6000K/2 \
-b:v:1 4500K -maxrate:v:1 4500K -bufsize:v:1 4500K/2 \
-b:v:2 3000K -maxrate:v:2 3000K -bufsize:v:2 3000K/2 \
-b:v:3 2000K -maxrate:v:3 2000K -bufsize:v:3 2000K/2 \
-b:v:4 1100K -maxrate:v:4 1100K -bufsize:v:4 1100K/2 \
-b:v:5 730K -maxrate:v:5 730K -bufsize:v:5 730K/2 \
-b:v:6 365K -maxrate:v:6 365K -bufsize:v:6 365K/2 \
\
-g:v 30 -keyint_min:v 30 -sc_threshold:v 0 \
\
-color_primaries bt709 -color_trc bt709 -colorspace bt709 \
\
-c:a aac -ar 48000 -b:a 96k \
\
-map [s0] -map [s1] -map [s2] -map [s3] -map [s4] -map [s5] -map [s6] \
-map 0:a:0 \
\
-preset ultrafast \
\
-adaptation_sets 'id=0,seg_duration=2.002,streams=v id=1,seg_duration=2.002,streams=a' \
-use_timeline 0 \
-streaming 1 \
-window_size 15 \
-frag_type every_frame \
-ldash 1 \
-utc_timing_url 'https://time.akamai.com?iso&amp;ms' \
-format_options 'movflags=cmaf' \
-write_prft 1 \
-target_latency '3.0' \
-timeout 0.5 \
-http_user_agent Akamai_Broadcaster_v1.0 \
-http_persistent 1 \
-media_seg_name $timestamp'/chunk-stream_$RepresentationID$-$Number%05d$.$ext$' \
-init_seg_name $timestamp'/init-stream_$RepresentationID$.$ext$' \
-f dash \
http://p-ep$stream.i.akamaientrypoint.net/cmaf/$stream/$event/out.mpd
