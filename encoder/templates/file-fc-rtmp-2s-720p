#!/bin/bash

#Generated by command builder r0.3j
#Script expect one variables to be set 'rtmp_url'

timestamp="$(date +%s)"

ffmpeg \
\
-re -fflags +genpts -stream_loop -1 -i testclip.mp4 \
\
-flags +global_header -r 30000/1001 \
\
-filter_complex "settb=AVTB,setpts='trunc(PTS/1K)*1K+st(1,trunc(RTCTIME/1K))-1K*trunc(ld(1)/1K)',\
drawbox=x=0:y=0:width=400:height=100:color=black@0.5:t=fill,\
drawtext=text='%{localtime\:%M}\:%{localtime\:%S}.%{eif\:1M*t-1K*trunc(t*1K)\:d\:3}':x=15:y=20:\
fontfile=/usr/share/fonts/truetype/freefont/FreeSans.ttf:fontsize=80:fontcolor=white,\
split=1[s0];\
[s0]scale=1280x720[s0]" \
\
-pix_fmt yuv420p \
-c:v libx264 \
\
-b:v:0 3000K -maxrate:v:0 3000K -bufsize:v:0 3000K/2 \
\
-g:v 30 -keyint_min:v 30 -sc_threshold:v 0 \
\
-color_primaries bt709 -color_trc bt709 -colorspace bt709 \
\
-c:a aac -ar 48000 -b:a 96k \
\
-map [s0] \
-map 0:a:0 \
\
-preset veryfast \
-tune zerolatency \
\
-f flv ${rtmp_url}
